from __future__ import annotations
import refractor.framework as rf  # type: ignore
from refractor.muses import (
    CurrentStateDict,
    CurrentStateUip,
    RetrievalStrategy,
    MusesRunDir,
    ProcessLocation,
    StateElementIdentifier,
    OspL2SetupControlInitial,
    TesFile,
    RetrievalGridArray,
    FullGridArray,
    FullGridMappedArray,
)
import pytest
import numpy.testing as npt
import numpy as np
from fixtures.misc_fixture import all_output_disabled
from typing import Any
from pathlib import Path


class RetrievalStrategyStop:
    def notify_update(
        self,
        retrieval_strategy: RetrievalStrategy,
        location: ProcessLocation,
        **kwargs: Any,
    ) -> None:
        if location == ProcessLocation("initial set up done"):
            raise StopIteration()


def test_current_state_dict():
    d = {
        StateElementIdentifier("TROPOMISOLARSHIFTBAND3"): 1.0,
        StateElementIdentifier("TROPOMIRADIANCESHIFTBAND3"): 2.0,
        StateElementIdentifier("TROPOMIRADSQUEEZEBAND3"): 3.0,
    }
    cs = CurrentStateDict(
        d,
        [
            StateElementIdentifier("TROPOMISOLARSHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADIANCESHIFTBAND3"),
        ],
    )
    coeff, mp = cs.object_state(
        [
            StateElementIdentifier("TROPOMISOLARSHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADIANCESHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADSQUEEZEBAND3"),
        ]
    )
    npt.assert_allclose(coeff, [1.0, 2.0, 3.0])
    npt.assert_allclose(mp.retrieval_indexes, [0, 1])
    cs = CurrentStateDict(
        d,
        [
            StateElementIdentifier("TROPOMISOLARSHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADSQUEEZEBAND3"),
        ],
    )
    coeff, mp = cs.object_state(
        [
            StateElementIdentifier("TROPOMISOLARSHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADIANCESHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADSQUEEZEBAND3"),
        ]
    )
    npt.assert_allclose(coeff, [1.0, 2.0, 3.0])
    npt.assert_allclose(mp.retrieval_indexes, [0, 2])


def test_current_state_uip(joint_tropomi_step_12):
    rs, rstep, _ = joint_tropomi_step_12
    rf_uip = rs.strategy_executor.rf_uip_func_cost_function(False, None)(None)
    cs = CurrentStateUip(rf_uip)
    print(cs.fm_sv_loc)
    print(cs.fm_state_vector_size)
    coeff, mp = cs.object_state(
        [
            StateElementIdentifier("TROPOMISOLARSHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADIANCESHIFTBAND3"),
            StateElementIdentifier("TROPOMIRADSQUEEZEBAND3"),
        ]
    )
    print(coeff)
    print(mp)
    print(mp.retrieval_indexes)


def test_current_state(
    isolated_dir, osp_dir, gmao_dir, vlidort_cli, joint_tropomi_test_in_dir
):
    try:
        with all_output_disabled():
            r = MusesRunDir(
                joint_tropomi_test_in_dir, osp_dir, gmao_dir, path_prefix="."
            )
            rs = RetrievalStrategy(r.run_dir / "Table.asc")
            rs.register_with_muses_py()
            rs.clear_observers()
            rs.add_observer(RetrievalStrategyStop())
            rs.retrieval_ms()
    except StopIteration:
        pass
    cstate = rs.current_state
    assert cstate.sounding_metadata.wrong_tai_time == pytest.approx(839312679.58409)
    assert cstate.state_value(StateElementIdentifier("EMIS"))[0] == pytest.approx(
        0.98081997
    )
    assert cstate.state_spectral_domain_wavelength(
        StateElementIdentifier("EMIS")
    )[0] == pytest.approx(600)
    assert cstate.sounding_metadata.latitude.value == pytest.approx(62.8646)
    assert cstate.sounding_metadata.longitude.value == pytest.approx(81.0379)
    assert cstate.sounding_metadata.surface_altitude.convert(
        "m"
    ).value == pytest.approx(169.827)
    assert cstate.sounding_metadata.tai_time == pytest.approx(839312683.58409)
    assert cstate.sounding_metadata.sounding_id == "20190807_065_04_08_5"
    assert cstate.sounding_metadata.is_land
    assert cstate.state_value(StateElementIdentifier("CLOUDEXT"))[0] == pytest.approx(
        1e-29
    )
    assert cstate.state_spectral_domain_wavelength(StateElementIdentifier("CLOUDEXT"))[
        0
    ] == pytest.approx(600)
    assert cstate.state_value(StateElementIdentifier("PCLOUD"))[0] == pytest.approx(
        500.0
    )
    assert cstate.state_value(StateElementIdentifier("PSUR"))[0] == pytest.approx(0.0)
    assert cstate.sounding_metadata.local_hour == pytest.approx(11.40252685546875)
    assert cstate.sounding_metadata.height.value[0] == 0
    assert cstate.state_value(StateElementIdentifier("TATM"))[0] == pytest.approx(
        293.28302002
    )


def test_update_cloudfraction(omi_step_0):
    """Test updating OMICLOUDFRACTION. Nothing particularly special about this
    StateElement, it is just a good simple test case for checking the muses-py
    species handling."""
    rs, _, _ = omi_step_0
    cstate = rs.current_state
    rs._strategy_executor.restart()

    # Update results, and make sure element gets updated
    rs.current_state.notify_start_step(rs.current_strategy_step, rs.retrieval_config)
    results_list = np.zeros((len(rs.current_state.retrieval_state_vector_element_list)))
    msk = (
        np.array([str(i) for i in rs.current_state.retrieval_state_vector_element_list])
        == "OMICLOUDFRACTION"
    )
    results_list[msk] = 0.5
    cstate.notify_step_solution(results_list)
    # Go to the next step, and check that the state element is updated
    rs._strategy_executor.next_step()
    rs._strategy_executor.notify_start_step()


# We will come back to this in a short bit
@pytest.mark.skip
def test_work(isolated_dir, osp_dir, gmao_dir, vlidort_cli, joint_tropomi_test_in_dir):
    try:
        # with all_output_disabled():
        if True:
            r = MusesRunDir(
                joint_tropomi_test_in_dir, osp_dir, gmao_dir, path_prefix="."
            )
            rs = RetrievalStrategy(r.run_dir / "Table.asc")
            rs.register_with_muses_py()
            rs.clear_observers()
            rs.add_observer(RetrievalStrategyStop())
            rs.retrieval_ms()
    except StopIteration:
        pass
    cstate = rs.current_state
    # We want to figure out how to make our own states matching StateInfoOld, so
    # go ahead and try working this
    l2setup = OspL2SetupControlInitial.read(
        Path(rs.retrieval_config["initialGuessSetupDirectory"])
    )
    f = TesFile(l2setup["Single_State_Directory"] / "State_AtmProfiles.asc")
    print(cstate.state_value(StateElementIdentifier("NH3")))
    print(f.table["NH3"])
    breakpoint()


def test_retrieval_grid_array():
    # This was extracted from a run with H2O, just so we have data that we know we can
    # compare to
    initial_value_fm = np.array(
        [
            8.66739539e-03,
            8.55553761e-03,
            7.11804676e-03,
            5.34054491e-03,
            3.26749879e-03,
            2.20908274e-03,
            9.72164161e-04,
            4.19964877e-04,
            1.81420308e-04,
            2.08378923e-04,
            2.39343268e-04,
            1.72093434e-04,
            1.23743178e-04,
            7.09822452e-05,
            4.07172545e-05,
            2.63761410e-05,
            1.70857268e-05,
            1.40434202e-05,
            1.15427766e-05,
            9.48741114e-06,
            7.90044592e-06,
            6.57874365e-06,
            5.47835306e-06,
            5.19379225e-06,
            4.92403373e-06,
            4.66828931e-06,
            4.42581951e-06,
            4.19594658e-06,
            3.97800957e-06,
            4.09716029e-06,
            4.21989380e-06,
            4.34629150e-06,
            4.47647273e-06,
            4.61055634e-06,
            4.74865507e-06,
            4.89088829e-06,
            5.03738191e-06,
            5.18826445e-06,
            5.34367176e-06,
            5.35270704e-06,
            5.36175894e-06,
            5.37082475e-06,
            5.37990610e-06,
            5.38900288e-06,
            5.39811503e-06,
            5.40724273e-06,
            5.41638598e-06,
            5.42554421e-06,
            5.43471790e-06,
            5.44390797e-06,
            5.45311338e-06,
            5.46233394e-06,
            5.48082189e-06,
            5.50867107e-06,
            5.51798560e-06,
            5.55540219e-06,
            5.57420494e-06,
            5.59307197e-06,
            5.62149154e-06,
            5.64051853e-06,
            5.66917941e-06,
            5.70762071e-06,
            5.76577213e-06,
            5.82451589e-06,
            5.90377268e-06,
        ]
    ).view(FullGridMappedArray)
    initial_value_ret = np.array(
        [
            -4.74818695,
            -4.94512192,
            -5.23242759,
            -5.72373048,
            -6.1151779,
            -6.93598588,
            -8.61469407,
            -8.33761177,
            -8.99730228,
            -10.10885861,
            -10.97726713,
            -11.56554478,
            -12.11470604,
            -12.43472897,
            -12.13959755,
            -12.03991897,
        ]
    ).view(RetrievalGridArray)
    initial_value_full = np.array(
        [
            -4.74818695,
            -4.76117653,
            -4.94512192,
            -5.23242759,
            -5.72373048,
            -6.1151779,
            -6.93598588,
            -7.77533948,
            -8.61469407,
            -8.47615239,
            -8.33761177,
            -8.66747301,
            -8.99730228,
            -9.55308078,
            -10.10885861,
            -10.54305071,
            -10.97726713,
            -11.17335658,
            -11.36945072,
            -11.56554478,
            -11.74859135,
            -11.93166677,
            -12.11470604,
            -12.16804644,
            -12.2213825,
            -12.27471787,
            -12.3280551,
            -12.3813916,
            -12.43472897,
            -12.40521644,
            -12.3757006,
            -12.3461876,
            -12.31667516,
            -12.28716203,
            -12.25764912,
            -12.22813662,
            -12.19862407,
            -12.16911132,
            -12.13959755,
            -12.13790814,
            -12.13621848,
            -12.13452908,
            -12.13283964,
            -12.13115019,
            -12.12946073,
            -12.12777126,
            -12.12608176,
            -12.12439235,
            -12.12270294,
            -12.12101338,
            -12.11932385,
            -12.1176344,
            -12.11425549,
            -12.10918715,
            -12.10749769,
            -12.10073974,
            -12.09736086,
            -12.09398187,
            -12.08891353,
            -12.08553456,
            -12.08046618,
            -12.07370831,
            -12.06357148,
            -12.05343467,
            -12.03991897,
        ]
    ).view(FullGridArray)
    constraint_vector_ret = np.array(
        [
            -4.74818695,
            -4.94512192,
            -5.23242759,
            -5.72373048,
            -6.1151779,
            -6.93598588,
            -8.61469407,
            -8.33761177,
            -8.99730228,
            -10.10885861,
            -10.97726713,
            -11.56554478,
            -12.11470604,
            -12.43472897,
            -12.13959755,
            -12.03991897,
        ]
    ).view(RetrievalGridArray)
    constraint_vector_fm = np.array(
        [
            8.61319248e-03,
            8.61319248e-03,
            7.11489418e-03,
            5.34054491e-03,
            3.26749879e-03,
            2.20908274e-03,
            1.16506219e-03,
            2.92411237e-04,
            2.07323956e-04,
            2.29163575e-04,
            2.20512375e-04,
            1.84353033e-04,
            1.18173833e-04,
            7.26544447e-05,
            4.08178727e-05,
            2.56422054e-05,
            1.71905070e-05,
            1.42286714e-05,
            1.15171471e-05,
            9.66963416e-06,
            7.82211462e-06,
            6.28418315e-06,
            5.80625569e-06,
            5.32827598e-06,
            4.85033502e-06,
            4.37240033e-06,
            4.33592087e-06,
            4.29944190e-06,
            4.26296234e-06,
            4.25207477e-06,
            4.30625051e-06,
            4.36042100e-06,
            4.41459048e-06,
            4.46522328e-06,
            4.51483034e-06,
            4.56234210e-06,
            4.60728804e-06,
            4.65223430e-06,
            4.69970141e-06,
            4.75023396e-06,
            4.80077377e-06,
            4.85130607e-06,
            4.92131240e-06,
            5.05849487e-06,
            5.19567791e-06,
            5.33286313e-06,
            5.47004962e-06,
            5.60722957e-06,
            5.74440901e-06,
            5.88160083e-06,
            5.91251745e-06,
            5.94343240e-06,
            5.99673547e-06,
            5.99888427e-06,
            6.05645281e-06,
            6.28548369e-06,
            6.34923556e-06,
            6.40182573e-06,
            6.44586813e-06,
            6.46713615e-06,
            6.49903768e-06,
            6.39066163e-06,
            5.92522030e-06,
            4.99335328e-06,
            3.69527126e-06,
        ]
    ).view(FullGridMappedArray)
    bmatrix = np.array(
        [
            [
                1.0,
                0.93404126,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.06595874,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                1.0,
                0.5000003,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.4999997,
                1.0,
                0.49999809,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.50000191,
                1.0,
                0.49997577,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.50002423,
                1.0,
                0.4999997,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.5000003,
                1.0,
                0.50001401,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.49998599,
                1.0,
                0.66667193,
                0.33333591,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.33332807,
                0.66666409,
                1.0,
                0.66667974,
                0.33330697,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.33332026,
                0.66669303,
                1.0,
                0.83332318,
                0.66665995,
                0.49999887,
                0.33333197,
                0.16666734,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.16667682,
                0.33334005,
                0.50000113,
                0.66666803,
                0.83333266,
                1.0,
                0.90000206,
                0.79999292,
                0.69999343,
                0.59999579,
                0.49999583,
                0.39999664,
                0.29999879,
                0.20000082,
                0.10000214,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.09999794,
                0.20000708,
                0.30000657,
                0.40000421,
                0.50000417,
                0.60000336,
                0.70000121,
                0.79999918,
                0.89999786,
                1.0,
                0.98305142,
                0.96610034,
                0.94915187,
                0.93220299,
                0.915254,
                0.898305,
                0.88135576,
                0.86440629,
                0.84745771,
                0.83050919,
                0.81355906,
                0.79660928,
                0.77966028,
                0.74576223,
                0.69491541,
                0.67796636,
                0.61016887,
                0.57627118,
                0.54237235,
                0.49152547,
                0.45762679,
                0.40677953,
                0.33898294,
                0.23728776,
                0.1355928,
                0.0,
            ],
            [
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.01694858,
                0.03389966,
                0.05084813,
                0.06779701,
                0.084746,
                0.101695,
                0.11864424,
                0.13559371,
                0.15254229,
                0.16949081,
                0.18644094,
                0.20339072,
                0.22033972,
                0.25423777,
                0.30508459,
                0.32203364,
                0.38983113,
                0.42372882,
                0.45762765,
                0.50847453,
                0.54237321,
                0.59322047,
                0.66101706,
                0.76271224,
                0.8644072,
                1.0,
            ],
        ]
    )
    mmatrix = np.array(
        [
            [
                5.35144562e-01,
                -3.28264708e-02,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                4.97681909e-01,
                3.51445618e-02,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                -3.28264708e-02,
                9.97681909e-01,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                1.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                8.28426974e-01,
                -1.42135859e-01,
                2.43869284e-02,
                -4.18353373e-03,
                7.14674468e-04,
                -1.04553979e-04,
                2.27449582e-05,
                -3.48452368e-06,
                6.53519825e-07,
                -7.67931472e-08,
                6.39216535e-08,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.43145847e-01,
                2.84271549e-01,
                -4.87738278e-02,
                8.36706247e-03,
                -1.42934808e-03,
                2.09107834e-04,
                -4.54898892e-05,
                6.96904320e-06,
                -1.30703887e-06,
                1.53586203e-07,
                -1.27843231e-07,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.42135859e-01,
                7.10679467e-01,
                -1.21934671e-01,
                2.09176736e-02,
                -3.57337319e-03,
                5.22770021e-04,
                -1.13724818e-04,
                1.74226225e-05,
                -3.26759990e-06,
                3.83965828e-07,
                -3.19608344e-07,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.88741479e-02,
                2.94370810e-01,
                2.92644257e-01,
                -5.02025962e-02,
                8.57612634e-03,
                -1.25465254e-03,
                2.72940539e-04,
                -4.18144436e-05,
                7.84226781e-06,
                -9.21521282e-07,
                7.67062768e-07,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.43869284e-02,
                -1.21934671e-01,
                7.07220023e-01,
                -1.21322323e-01,
                2.07255332e-02,
                -3.03206153e-03,
                6.59602946e-04,
                -1.01051058e-04,
                1.89520508e-05,
                -2.22699843e-06,
                1.85372559e-06,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.01010051e-02,
                -5.05050376e-02,
                2.92928775e-01,
                2.92861626e-01,
                -5.00296498e-02,
                7.31913506e-03,
                -1.59222463e-03,
                2.43928539e-04,
                -4.57486162e-05,
                5.37578216e-06,
                -4.47473371e-06,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -4.18353373e-03,
                2.09176736e-02,
                -1.21322323e-01,
                7.07005437e-01,
                -1.20777976e-01,
                1.76693285e-02,
                -3.84383398e-03,
                5.88874704e-04,
                -1.10443013e-04,
                1.29778259e-05,
                -1.08025797e-05,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.73442817e-03,
                8.67214291e-03,
                -5.02983528e-02,
                2.93113484e-01,
                2.91588199e-01,
                -4.26581722e-02,
                9.27997527e-03,
                -1.42169061e-03,
                2.66637018e-04,
                -3.13317132e-05,
                2.60801255e-05,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                7.14674468e-04,
                -3.57337319e-03,
                2.07255332e-02,
                -1.20777976e-01,
                7.03953883e-01,
                -1.02985601e-01,
                2.24037689e-02,
                -3.43225354e-03,
                6.43716598e-04,
                -7.56411996e-05,
                6.29627867e-05,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.05071720e-04,
                -1.52535896e-03,
                8.84706860e-03,
                -5.15562628e-02,
                3.00495444e-01,
                2.48622434e-01,
                -5.40860034e-02,
                8.28596641e-03,
                -1.55402684e-03,
                1.82609015e-04,
                -1.52001456e-04,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.04553979e-04,
                5.22770021e-04,
                -3.03206153e-03,
                1.76693285e-02,
                -1.02985601e-01,
                6.00250170e-01,
                -1.30580061e-01,
                2.00048429e-02,
                -3.75189342e-03,
                4.40873700e-04,
                -3.66977744e-04,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.21216703e-05,
                3.10608426e-04,
                -1.80152614e-03,
                1.04983876e-02,
                -6.11898045e-02,
                3.56643941e-01,
                8.55695036e-02,
                -1.31092332e-02,
                2.45862694e-03,
                -2.88905851e-04,
                2.40481610e-04,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.96883485e-05,
                9.84417659e-05,
                -5.70961379e-04,
                3.32727554e-03,
                -1.93930103e-02,
                1.13031896e-01,
                3.01724229e-01,
                -4.62240999e-02,
                8.66929556e-03,
                -1.01870282e-03,
                8.47955465e-04,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.27449582e-05,
                -1.13724818e-04,
                6.59602946e-04,
                -3.84383398e-03,
                2.24037689e-02,
                -1.30580061e-01,
                5.17878876e-01,
                -7.93389547e-02,
                1.48799620e-02,
                -1.74849953e-03,
                1.45542910e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.40021405e-05,
                -7.00107190e-05,
                4.06061556e-04,
                -2.36632237e-03,
                1.37920992e-02,
                -8.03870619e-02,
                3.18814073e-01,
                6.60565022e-02,
                -1.23888479e-02,
                1.45577622e-03,
                -1.21176988e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.25794539e-06,
                -2.62897332e-05,
                1.52480222e-04,
                -8.88577987e-04,
                5.17907276e-03,
                -3.01861550e-02,
                1.19717910e-01,
                2.11474865e-01,
                -3.96619536e-02,
                4.66055677e-03,
                -3.87938906e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -3.48452368e-06,
                1.74226225e-05,
                -1.01051058e-04,
                5.88874704e-04,
                -3.43225354e-03,
                2.00048429e-02,
                -7.93389547e-02,
                3.56864524e-01,
                -6.69296761e-02,
                7.86470475e-03,
                -6.54648168e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -2.79480775e-06,
                1.39740421e-05,
                -8.10493214e-05,
                4.72314651e-04,
                -2.75288380e-03,
                1.60451457e-02,
                -6.36348454e-02,
                2.86227855e-01,
                -2.15288594e-02,
                2.52979146e-03,
                -2.10576671e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -2.10514806e-06,
                1.05257428e-05,
                -6.10492158e-05,
                3.55764102e-04,
                -2.07356945e-03,
                1.20857713e-02,
                -4.79320164e-02,
                2.15596945e-01,
                2.38682555e-02,
                -2.80468685e-03,
                2.33458619e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.41549724e-06,
                7.07748789e-06,
                -4.10493677e-05,
                2.39215054e-04,
                -1.39426385e-03,
                8.12644785e-03,
                -3.22293897e-02,
                1.44966944e-01,
                6.92647860e-02,
                -8.13909648e-03,
                6.77488192e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -7.25822378e-07,
                3.62911275e-06,
                -2.10488221e-05,
                1.22661941e-04,
                -7.14934566e-04,
                4.16698637e-03,
                -1.65262154e-02,
                7.43344805e-02,
                1.14662899e-01,
                -1.34736921e-02,
                1.12153325e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -3.61568879e-08,
                1.80784482e-07,
                -1.04854841e-06,
                6.11041239e-06,
                -3.56145108e-05,
                2.07578691e-04,
                -8.23254469e-04,
                3.70297687e-03,
                1.60060396e-01,
                -1.88082153e-02,
                1.56557227e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                6.53519825e-07,
                -3.26759990e-06,
                1.89520508e-05,
                -1.10443013e-04,
                6.43716598e-04,
                -3.75189342e-03,
                1.48799620e-02,
                -6.69296761e-02,
                2.05458631e-01,
                -2.41428252e-02,
                2.00961852e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.80490034e-07,
                -2.90245086e-06,
                1.68341895e-05,
                -9.81011834e-05,
                5.71782302e-04,
                -3.33262535e-03,
                1.32171501e-02,
                -5.94503922e-02,
                1.82498959e-01,
                -1.43234451e-02,
                1.19226562e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.07452059e-07,
                -2.53726090e-06,
                1.47160910e-05,
                -8.57579711e-05,
                4.99839945e-04,
                -2.91331030e-03,
                1.15541519e-02,
                -5.19702703e-02,
                1.59536714e-01,
                -4.50296467e-03,
                3.74821137e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                4.34421136e-07,
                -2.17210620e-06,
                1.25981969e-05,
                -7.34159505e-05,
                4.27904534e-04,
                -2.49403574e-03,
                9.89131429e-03,
                -4.44908705e-02,
                1.36576686e-01,
                5.31656760e-03,
                -4.42544425e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.61391563e-07,
                -1.80695824e-06,
                1.04803420e-05,
                -6.10741579e-05,
                3.55970452e-04,
                -2.07476893e-03,
                8.22850739e-03,
                -3.70116090e-02,
                1.13617082e-01,
                1.51359184e-02,
                -1.25989488e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.88360292e-07,
                -1.44180180e-06,
                8.36243780e-06,
                -4.87320785e-05,
                2.84034698e-04,
                -1.65549236e-03,
                6.56566183e-03,
                -2.95321736e-02,
                9.06569450e-02,
                2.49554975e-02,
                -2.07726434e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.15329586e-07,
                -1.07664819e-06,
                6.24455005e-06,
                -3.63900946e-05,
                2.12099501e-04,
                -1.23621905e-03,
                4.90282916e-03,
                -2.20527961e-02,
                6.76969854e-02,
                3.47750005e-02,
                -2.89462747e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.42299861e-07,
                -7.11499473e-07,
                4.12669070e-06,
                -2.40482763e-05,
                1.40165269e-04,
                -8.16951361e-04,
                3.24001879e-03,
                -1.45735190e-02,
                4.47373339e-02,
                4.45943718e-02,
                -3.71197963e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                6.92700479e-08,
                -3.46350322e-07,
                2.00882883e-06,
                -1.17064433e-05,
                6.82309517e-05,
                -3.97683172e-04,
                1.57720644e-03,
                -7.09423294e-03,
                2.17776549e-02,
                5.44137549e-02,
                -4.52933277e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -3.76028729e-09,
                1.88014409e-08,
                -1.09048192e-07,
                6.35477979e-07,
                -3.70388051e-06,
                2.15880171e-05,
                -8.56178033e-05,
                3.85106619e-04,
                -1.18218828e-03,
                6.42332081e-02,
                -5.34669176e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -7.67931472e-08,
                3.83965828e-07,
                -2.22699843e-06,
                1.29778259e-05,
                -7.56411996e-05,
                4.40873700e-04,
                -1.74849953e-03,
                7.86470475e-03,
                -2.41428252e-02,
                7.40530008e-02,
                -6.16407900e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -7.44082310e-08,
                3.72041244e-07,
                -2.15783595e-06,
                1.25747818e-05,
                -7.32920587e-05,
                4.27181765e-04,
                -1.69419749e-03,
                7.62045559e-03,
                -2.33930368e-02,
                7.17531837e-02,
                -5.61265998e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -7.20229626e-08,
                3.60114899e-07,
                -2.08866325e-06,
                1.21716782e-05,
                -7.09425709e-05,
                4.13487807e-04,
                -1.63988743e-03,
                7.37617036e-03,
                -2.26431376e-02,
                6.94530268e-02,
                -5.06115951e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.96380632e-08,
                3.48190399e-07,
                -2.01950126e-06,
                1.17686369e-05,
                -6.85934466e-05,
                3.99795968e-04,
                -1.58558577e-03,
                7.13192292e-03,
                -2.18933544e-02,
                6.71532258e-02,
                -4.50974436e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.72531051e-08,
                3.36265606e-07,
                -1.95033756e-06,
                1.13655857e-05,
                -6.62442644e-05,
                3.86103792e-04,
                -1.53128277e-03,
                6.88766947e-03,
                -2.11435528e-02,
                6.48533682e-02,
                -3.95831564e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.48681303e-08,
                3.24340729e-07,
                -1.88117338e-06,
                1.09625316e-05,
                -6.38950657e-05,
                3.72411519e-04,
                -1.47697939e-03,
                6.64341430e-03,
                -2.03937459e-02,
                6.25534944e-02,
                -3.40688305e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.24831554e-08,
                3.12415851e-07,
                -1.81200920e-06,
                1.05594776e-05,
                -6.15458671e-05,
                3.58719247e-04,
                -1.42267601e-03,
                6.39915913e-03,
                -1.96439390e-02,
                6.02536206e-02,
                -2.85545045e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -6.00981470e-08,
                3.00490806e-07,
                -1.74284404e-06,
                1.01564179e-05,
                -5.91966353e-05,
                3.45026782e-04,
                -1.36837186e-03,
                6.15490052e-03,
                -1.88941216e-02,
                5.79537145e-02,
                -2.30401010e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.77131050e-08,
                2.88565594e-07,
                -1.67367791e-06,
                9.75335247e-06,
                -5.68473706e-05,
                3.31334124e-04,
                -1.31406696e-03,
                5.91063848e-03,
                -1.81442936e-02,
                5.56537760e-02,
                -1.75256199e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.53281888e-08,
                2.76641010e-07,
                -1.60451543e-06,
                9.35030834e-06,
                -5.44982297e-05,
                3.17642189e-04,
                -1.25976491e-03,
                5.66638932e-03,
                -1.73945051e-02,
                5.33539588e-02,
                -1.20114296e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.29432811e-08,
                2.64716468e-07,
                -1.53535319e-06,
                8.94726563e-06,
                -5.21490971e-05,
                3.03950301e-04,
                -1.20546306e-03,
                5.42214102e-03,
                -1.66447193e-02,
                5.10541498e-02,
                -6.49725882e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.05581468e-08,
                2.52790794e-07,
                -1.46618439e-06,
                8.54418466e-06,
                -4.97997415e-05,
                2.90257114e-04,
                -1.15115605e-03,
                5.17786953e-03,
                -1.58948623e-02,
                4.87541223e-02,
                -9.82564402e-04,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -4.81730629e-08,
                2.40865372e-07,
                -1.39701704e-06,
                8.14111218e-06,
                -4.74504354e-05,
                2.76564215e-04,
                -1.09685019e-03,
                4.93360320e-03,
                -1.51450211e-02,
                4.64541434e-02,
                4.53201366e-03,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -4.57880881e-08,
                2.28940495e-07,
                -1.32785286e-06,
                7.73805813e-06,
                -4.51012367e-05,
                2.62871943e-04,
                -1.04254681e-03,
                4.68934803e-03,
                -1.43952142e-02,
                4.41542696e-02,
                1.00463396e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -4.10181299e-08,
                2.05090699e-07,
                -1.18952425e-06,
                6.93194862e-06,
                -4.04028311e-05,
                2.35487350e-04,
                -9.33939859e-04,
                4.20083683e-03,
                -1.28955978e-02,
                3.95545139e-02,
                2.10750110e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -3.38632305e-08,
                1.69316193e-07,
                -9.82032432e-07,
                5.72279073e-06,
                -3.33552598e-05,
                1.94410677e-04,
                -7.71030292e-04,
                3.46807390e-03,
                -1.06461850e-02,
                3.26549168e-02,
                3.76179307e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -3.14782472e-08,
                1.57391274e-07,
                -9.12868006e-07,
                5.31973527e-06,
                -3.10060529e-05,
                1.80718356e-04,
                -7.16726721e-04,
                3.22381787e-03,
                -9.89637550e-03,
                3.03550350e-02,
                4.31322760e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -2.19381380e-08,
                1.09690716e-07,
                -6.36205193e-07,
                3.70748364e-06,
                -2.16090516e-05,
                1.25948062e-04,
                -4.99508427e-04,
                2.24677572e-03,
                -6.89708199e-03,
                2.11553376e-02,
                6.51900647e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.71682302e-08,
                8.58411717e-08,
                -4.97878043e-07,
                2.90138264e-06,
                -1.69106955e-05,
                9.85637582e-05,
                -3.90902622e-04,
                1.75826967e-03,
                -5.39748138e-03,
                1.65556305e-02,
                7.62186197e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -1.23981631e-08,
                6.19908302e-08,
                -3.59546271e-07,
                2.09525470e-06,
                -1.22121825e-05,
                7.11785391e-05,
                -2.82293188e-04,
                1.26974731e-03,
                -3.89783067e-03,
                1.19557697e-02,
                8.72475431e-02,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -5.24325524e-09,
                2.62162824e-08,
                -1.52054208e-07,
                8.86095392e-07,
                -5.16460297e-06,
                3.01018180e-05,
                -1.19383430e-04,
                5.36983518e-04,
                -1.64841525e-03,
                5.05616450e-03,
                1.03790482e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                -4.73209041e-10,
                2.36604577e-09,
                -1.37230447e-08,
                7.99709974e-08,
                -4.66110595e-07,
                2.71671925e-06,
                -1.07744743e-05,
                4.84633008e-05,
                -1.48771129e-04,
                4.56323914e-04,
                1.14819357e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                6.68175332e-09,
                -3.34087745e-08,
                1.93770599e-07,
                -1.12919752e-06,
                6.58152263e-06,
                -3.83603149e-05,
                1.52136525e-04,
                -6.84306073e-04,
                2.10066143e-03,
                -6.44333384e-03,
                1.31362422e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.62217367e-08,
                -8.11087027e-08,
                4.70429764e-07,
                -2.74142789e-06,
                1.59784000e-05,
                -9.31298864e-05,
                3.69351955e-04,
                -1.66133534e-03,
                5.09991539e-03,
                -1.56429099e-02,
                1.53419920e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.05317536e-08,
                -1.52658805e-07,
                8.85419727e-07,
                -5.15978052e-06,
                3.00737573e-05,
                -1.75284484e-04,
                6.95176054e-04,
                -3.12688354e-03,
                9.59880951e-03,
                -2.94423143e-02,
                1.86506264e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                4.48417392e-08,
                -2.24208749e-07,
                1.30040878e-06,
                -7.57812783e-06,
                4.41690837e-05,
                -2.57438902e-04,
                1.02099944e-03,
                -4.59242851e-03,
                1.40976937e-02,
                -4.32416885e-02,
                2.19592535e-01,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                6.39216535e-08,
                -3.19608344e-07,
                1.85372559e-06,
                -1.08025797e-05,
                6.29627867e-05,
                -3.66977744e-04,
                1.45542910e-03,
                -6.54648168e-03,
                2.00961852e-02,
                -6.16407900e-02,
                2.63707409e-01,
            ],
        ]
    )
    # smap_ret_to_fm = rf.StateMappingBasisMatrix(bmatrix.transpose())
    smap_ret_to_fm = rf.StateMappingBasisMatrix(
        bmatrix.transpose(), mmatrix.transpose()
    )
    smap = rf.StateMappingLog()
    npt.assert_allclose(
        smap_ret_to_fm.inverse_basis_matrix, mmatrix.transpose(), atol=1e-8
    )
    assert isinstance(initial_value_ret.to_full(smap_ret_to_fm), FullGridArray)
    assert isinstance(
        initial_value_ret.to_fm(smap_ret_to_fm, smap), FullGridMappedArray
    )
    npt.assert_allclose(initial_value_ret.to_full(smap_ret_to_fm), initial_value_full)
    npt.assert_allclose(initial_value_ret.to_fm(smap_ret_to_fm, smap), initial_value_fm)

    assert isinstance(initial_value_full.to_ret(smap_ret_to_fm), RetrievalGridArray)
    assert isinstance(initial_value_full.to_fm(smap), FullGridMappedArray)
    npt.assert_allclose(initial_value_full.to_ret(smap_ret_to_fm), initial_value_ret)
    npt.assert_allclose(initial_value_full.to_fm(smap), initial_value_fm)

    assert isinstance(initial_value_fm.to_full(smap), FullGridArray)
    assert isinstance(initial_value_fm.to_ret(smap_ret_to_fm, smap), RetrievalGridArray)
    npt.assert_allclose(initial_value_fm.to_full(smap), initial_value_full)
    npt.assert_allclose(
        initial_value_fm.to_ret(smap_ret_to_fm, smap), initial_value_ret
    )

    npt.assert_allclose(
        constraint_vector_ret.to_fm(smap_ret_to_fm, smap),
        constraint_vector_fm,
        atol=1e-3,
    )
    npt.assert_allclose(
        constraint_vector_fm.to_ret(smap_ret_to_fm, smap), constraint_vector_ret
    )
