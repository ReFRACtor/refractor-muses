from refractor.muses import ColumnResultSummary
from pytest import approx
import numpy.testing as npt


def test_column_result_summary(joint_tropomi_step_12_output):
    rs, _, _ = joint_tropomi_step_12_output
    current_state = rs.current_state
    error_analysis = rs.error_analysis
    csum = ColumnResultSummary(current_state, error_analysis)
    if False:
        print(csum.H2O_H2OQuality)
        print(csum.O3_columnErrorDU)
        print(csum.O3_tropo_consistency)
        print(repr(csum.columnDOFS))
        print(repr(csum.columnPriorError))
        print(repr(csum.columnInitial))
        print(repr(csum.columnInitialInitial))
        print(repr(csum.columnError))
        print(repr(csum.columnPrior))
        print(repr(csum.column))
        print(repr(csum.columnAir))
        print(repr(csum.columnTrue))
        print(repr(csum.columnPressureMax))
        print(repr(csum.columnPressureMin))
        print(repr(csum.columnSpecies))
    assert csum.H2O_H2OQuality == approx(0.0)
    assert csum.O3_columnErrorDU == approx(4.4427353779519585)
    assert csum.O3_tropo_consistency == approx(0.08971034002390521)
    npt.assert_allclose(
        csum.columnDOFS,
        [
            [3.27163655, 3.34031569, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [2.9539428, 0.65749302, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.32958092, 0.35961738, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.57919709, 0.29629491, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.29163234, 2.68498166, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
    )
    npt.assert_allclose(
        csum.columnPriorError,
        [
            [
                5.27094759e22,
                9.32418387e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.26953980e22,
                3.03460624e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.13403488e22,
                3.03558847e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                4.89710835e22,
                1.76502111e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.27029512e22,
                9.88232102e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnInitial,
        [
            [
                1.42267853e23,
                7.09515903e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.42137889e23,
                9.21674465e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.33860353e22,
                4.32437953e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.28753270e23,
                4.89238539e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.29985588e20,
                6.17347997e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnInitialInitial,
        [
            [
                1.42267853e23,
                7.09515903e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.42137889e23,
                9.21674465e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.33860353e22,
                4.32437953e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.28753270e23,
                4.89238539e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.29985588e20,
                6.17347997e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnError,
        [
            [
                9.96113911e21,
                1.19509582e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.95446432e21,
                1.09506892e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.00887670e22,
                1.06817749e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.05369634e22,
                1.12384685e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.95842062e21,
                1.32520437e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnPrior,
        [
            [
                8.15583316e22,
                8.07192885e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14138936e22,
                9.44340936e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.78930845e21,
                4.53171852e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.46251825e22,
                4.91171487e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.44447498e20,
                7.12758677e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.column,
        [
            [
                1.49220384e23,
                7.20058151e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.49094458e23,
                1.00435819e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.27219285e22,
                3.89935537e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.36374589e23,
                6.14429225e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.25945997e20,
                6.19622007e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnAir,
        [2.09838100e25, 1.58890549e25, 5.53351904e24, 1.03556205e25, 5.09477687e24],
    )
    npt.assert_allclose(
        csum.columnTrue,
        [
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnPressureMax, [986.3847, 986.3847, 500.0, 986.3847, 239.46082031]
    )
    npt.assert_allclose(
        csum.columnPressureMin, [0.0, 239.46082031, 239.46082031, 500.0, 0.0]
    )
    assert csum.columnSpecies == ["H2O", "O3"]
