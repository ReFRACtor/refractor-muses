from refractor.muses import ColumnResultSummary, ErrorAnalysis
from pytest import approx
import numpy.testing as npt


def test_column_result_summary(joint_tropomi_step_12_output):
    rs, rstep, _ = joint_tropomi_step_12_output
    current_state = rs.current_state
    e = ErrorAnalysis(rs.current_state, rs.current_strategy_step, rstep.results)
    csum = ColumnResultSummary(current_state, e)
    if False:
        print(csum.H2O_H2OQuality)
        print(csum.O3_columnErrorDU)
        print(csum.O3_tropo_consistency)
        print(repr(csum.columnDOFS))
        print(repr(csum.columnPriorError))
        print(repr(csum.columnInitial))
        print(repr(csum.columnInitialInitial))
        print(repr(csum.columnError))
        print(repr(csum.columnPrior))
        print(repr(csum.column))
        print(repr(csum.columnAir))
        print(repr(csum.columnTrue))
        print(repr(csum.columnPressureMax))
        print(repr(csum.columnPressureMin))
        print(repr(csum.columnSpecies))
    assert csum.H2O_H2OQuality == approx(0.0)
    assert csum.O3_columnErrorDU == approx(3.621294286750664)
    assert csum.O3_tropo_consistency == approx(0.004409025162657398)
    npt.assert_allclose(
        csum.columnDOFS,
        [
            [3.27151484, 3.34038076, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [2.95385707, 0.6576872, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.32931311, 0.3596918, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.57924642, 0.29641264, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.2915986, 2.68485775, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
    )
    npt.assert_allclose(
        csum.columnPriorError,
        [
            [
                5.27093494e22,
                9.67578874e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.26952715e22,
                3.33127736e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.13402234e22,
                3.26667080e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                4.89709594e22,
                2.16760495e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.27028247e22,
                1.03018639e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnInitial,
        [
            [
                1.42267853e23,
                7.38079965e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.42137889e23,
                1.00022194e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.33860353e22,
                4.01037714e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.28753270e23,
                5.99190303e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.29985588e20,
                6.38057436e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnInitialInitial,
        [
            [
                8.15584360e22,
                8.07192406e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14139967e22,
                9.44342573e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.78932079e21,
                4.53173553e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.46252758e22,
                4.91171413e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.44452830e20,
                7.12757876e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnError,
        [
            [
                9.34126403e21,
                9.74128163e16,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.33931943e21,
                1.08610214e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.30658679e21,
                1.05954723e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.23466346e21,
                1.02014390e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.34036631e21,
                1.01842996e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnPrior,
        [
            [
                8.15583316e22,
                8.07192885e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14138936e22,
                9.44340936e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.78930845e21,
                4.53171852e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.46251825e22,
                4.91171487e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.44447498e20,
                7.12758677e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.column,
        [
            [
                1.49169183e23,
                7.20058236e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.49043281e23,
                1.00463194e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.27133944e22,
                3.90050887e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.36331951e23,
                6.14587631e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.25921843e20,
                6.19594714e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnAir,
        [2.09837910e25, 1.58890361e25, 5.53351572e24, 1.03556049e25, 5.09477683e24],
    )
    npt.assert_allclose(
        csum.columnTrue,
        [
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
    )
    npt.assert_allclose(
        csum.columnPressureMax, [986.3847, 986.3847, 500.0, 986.3847, 239.46082031]
    )
    npt.assert_allclose(
        csum.columnPressureMin, [0.0, 239.46082031, 239.46082031, 500.0, 0.0]
    )
    assert csum.columnSpecies == ["H2O", "O3"]
