from refractor.muses import ColumnResultSummary, ErrorAnalysis
from pytest import approx
import numpy.testing as npt


def test_column_result_summary(joint_tropomi_step_12_output):
    rs, rstep, _ = joint_tropomi_step_12_output
    current_state = rs.current_state
    e = ErrorAnalysis(rs.current_state, rs.current_strategy_step, rstep.results)
    csum = ColumnResultSummary(current_state, e)
    if False:
        print(f"""
    assert csum.H2O_H2OQuality == approx({csum.H2O_H2OQuality})
    assert csum.O3_columnErrorDU == approx({csum.O3_columnErrorDU})
    assert csum.O3_tropo_consistency == approx({csum.O3_tropo_consistency})
    npt.assert_allclose(
        csum.columnDOFS, {csum.columnDOFS.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPriorError, {csum.columnPriorError.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitial,{csum.columnInitial.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitialInitial,{csum.columnInitialInitial.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnError, {csum.columnError.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPrior, {csum.columnPrior.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.column, {csum.column.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnAir, {csum.columnAir.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnTrue,{csum.columnTrue.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMax, {csum.columnPressureMax.tolist()},
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMin, {csum.columnPressureMin.tolist()},
        rtol=1e-6,
    )
    assert csum.columnSpecies == ["H2O", "O3"]
""")

    assert csum.H2O_H2OQuality == approx(0.0)
    assert csum.O3_columnErrorDU == approx(3.6259871480670074)
    assert csum.O3_tropo_consistency == approx(0.004573540241236795)
    npt.assert_allclose(
        csum.columnDOFS,
        [
            [
                3.2696680722423412,
                3.3399133399916674,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                2.948546234062456,
                0.6566162119160487,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                1.3295207572839653,
                0.3594407608517385,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                1.5733467177044118,
                0.29561785935614143,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
            [
                0.29482780644517426,
                2.6854907302617144,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
                0.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPriorError,
        [
            [
                5.276256407226667e22,
                9.676367221351318e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                5.27484237154984e22,
                3.3301320708831475e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                5.13914376379737e22,
                3.265604248709844e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                4.9022402918007955e22,
                2.1660883675979315e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                5.2756007734777255e22,
                1.0302576264808809e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitial,
        [
            [
                1.4240508122535075e23,
                7.381304131748626e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.4227461194414582e23,
                9.998982794811802e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.33882334182526e22,
                4.011293639631176e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.2888778815257659e23,
                5.98774928472277e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.3050154527412873e20,
                6.381402759890993e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitialInitial,
        [
            [
                8.155842384062575e22,
                8.07192552709659e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                8.141399340057598e22,
                9.443425682697748e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                6.789319990499145e21,
                4.5317354427305165e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                7.462527632947695e22,
                4.9117142917840896e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.444528524947924e20,
                7.127579179255595e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnError,
        [
            [
                9.616797159849164e21,
                9.75390542830025e16,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                9.614909373028971e21,
                1.0915106646775678e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                9.554459373720522e21,
                1.0647307674970349e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                9.512638628269446e21,
                1.022889017862113e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                9.615943772446755e21,
                1.0192558615027998e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPrior,
        [
            [
                8.15471288127603e22,
                8.072272972770968e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                8.14015724728037e22,
                9.441089907683492e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                6.807425586901081e21,
                4.532097594372915e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                7.459448071522499e22,
                4.9090160215300506e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.4555370992480079e20,
                7.128163569685758e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.column,
        [
            [
                1.495897547756882e23,
                7.200655470816657e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.4946307752536951e23,
                1.0044713544995308e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.2781376746164146e22,
                3.9022413276092826e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.3668378932353256e23,
                6.142537844486308e17,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                1.2671611145764943e20,
                6.19618068034329e18,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnAir,
        [
            2.098397381721182e25,
            1.588921022958965e25,
            5.533547641992215e24,
            1.0355749633171033e25,
            5.094782034366244e24,
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnTrue,
        [
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMax,
        [986.3847, 986.3847, 500.0, 986.3847, 239.4608154296875],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMin,
        [0.0, 239.4608154296875, 239.4608154296875, 500.0, 0.0],
        rtol=1e-6,
    )
    assert csum.columnSpecies == ["H2O", "O3"]
