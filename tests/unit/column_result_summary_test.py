from refractor.muses import ColumnResultSummary, ErrorAnalysis
from pytest import approx
import numpy.testing as npt


def test_column_result_summary(joint_tropomi_step_12_output):
    rs, rstep, _ = joint_tropomi_step_12_output
    current_state = rs.current_state
    e = ErrorAnalysis(rs.current_state, rs.current_strategy_step, rstep.results)
    csum = ColumnResultSummary(current_state, e)
    if False:
        print(csum.H2O_H2OQuality)
        print(csum.O3_columnErrorDU)
        print(csum.O3_tropo_consistency)
        print(repr(csum.columnDOFS))
        print(repr(csum.columnPriorError))
        print(repr(csum.columnInitial))
        print(repr(csum.columnInitialInitial))
        print(repr(csum.columnError))
        print(repr(csum.columnPrior))
        print(repr(csum.column))
        print(repr(csum.columnAir))
        print(repr(csum.columnTrue))
        print(repr(csum.columnPressureMax))
        print(repr(csum.columnPressureMin))
        print(repr(csum.columnSpecies))
    assert csum.H2O_H2OQuality == approx(0.0)
    assert csum.O3_columnErrorDU == approx(3.625342526515213)
    assert csum.O3_tropo_consistency == approx(0.004409025162657398)
    npt.assert_allclose(
        csum.columnDOFS,
        [
            [3.27151484, 3.34038076, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [2.95385709, 0.65768722, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.32931312, 0.35969181, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.57924642, 0.29641264, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.29159857, 2.68485774, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPriorError,
        [
            [
                5.27093494e22,
                9.67578874e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.26952715e22,
                3.33127736e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.13402234e22,
                3.26667080e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                4.89709594e22,
                2.16760495e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.27028247e22,
                1.03018639e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitial,
        [
            [
                1.42267821e23,
                7.38079891e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.42137874e23,
                1.00022195e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.33860357e22,
                4.01037727e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.28753275e23,
                5.99190269e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.29985566e20,
                6.38057428e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitialInitial,
        [
            [
                8.15584238e22,
                8.07192553e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14139934e22,
                9.44342568e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.78931999e21,
                4.53173544e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.46252763e22,
                4.91171429e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.44452852e20,
                7.12757918e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnError,
        [
            [
                9.52250722e21,
                9.75217129e16,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.52065853e21,
                1.09081388e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.45768762e21,
                1.06400522e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.41865813e21,
                1.02287558e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.52167322e21,
                1.01915520e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPrior,
        [
            [
                8.15471288e22,
                8.07227297e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14015725e22,
                9.44108991e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.80742559e21,
                4.53209759e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.45944807e22,
                4.90901602e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.45553710e20,
                7.12816357e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.column,
        [
            [
                1.49169200e23,
                7.20058290e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.49043288e23,
                1.00463195e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.27133960e22,
                3.90050891e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.36331950e23,
                6.14587624e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.25921833e20,
                6.19594703e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnAir,
        [2.09837940e25, 1.58890350e25, 5.53351594e24, 1.03556044e25, 5.09477800e24],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnTrue,
        [
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMax,
        [986.3847, 986.3847, 500.0, 986.3847, 239.46081543],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMin,
        [0.0, 239.46081543, 239.46081543, 500.0, 0.0],
        rtol=1e-6,
    )
    assert csum.columnSpecies == ["H2O", "O3"]
