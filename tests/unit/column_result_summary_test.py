from refractor.muses import ColumnResultSummary, ErrorAnalysis
from pytest import approx
import numpy.testing as npt


def test_column_result_summary(joint_tropomi_step_12_output):
    rs, rstep, _ = joint_tropomi_step_12_output
    current_state = rs.current_state
    e = ErrorAnalysis(rs.current_state, rs.current_strategy_step, rstep.results)
    csum = ColumnResultSummary(current_state, e)
    if True:
        print(csum.H2O_H2OQuality)
        print(csum.O3_columnErrorDU)
        print(csum.O3_tropo_consistency)
        print(repr(csum.columnDOFS))
        print(repr(csum.columnPriorError))
        print(repr(csum.columnInitial))
        print(repr(csum.columnInitialInitial))
        print(repr(csum.columnError))
        print(repr(csum.columnPrior))
        print(repr(csum.column))
        print(repr(csum.columnAir))
        print(repr(csum.columnTrue))
        print(repr(csum.columnPressureMax))
        print(repr(csum.columnPressureMin))
        print(repr(csum.columnSpecies))
    assert csum.H2O_H2OQuality == approx(0.0)
    assert csum.O3_columnErrorDU == approx(3.625355411352962)
    assert csum.O3_tropo_consistency == approx(0.004354234083036035)
    npt.assert_allclose(
        csum.columnDOFS,
        [
            [3.26717459, 3.34003601, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [2.94607067, 0.65668561, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.32693462, 0.35937196, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [1.57325463, 0.29575549, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
            [0.2948398, 2.68554966, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPriorError,
        [
            [
                5.27622277e22,
                9.67636063e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.27480873e22,
                3.33011994e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.13911089e22,
                3.26559228e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                4.90220888e22,
                2.16608023e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                5.27556713e22,
                1.03025700e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitial,
        [
            [
                1.42405081e23,
                7.38130413e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.42274612e23,
                9.99898279e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.33882334e22,
                4.01129364e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.28887788e23,
                5.98774928e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.30501545e20,
                6.38140276e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnInitialInitial,
        [
            [
                8.15584238e22,
                8.07192553e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14139934e22,
                9.44342568e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.78931999e21,
                4.53173544e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.46252763e22,
                4.91171429e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.44452852e20,
                7.12757918e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnError,
        [
            [
                9.61989077e21,
                9.75220606e16,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.61802998e21,
                1.09113119e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.55768604e21,
                1.06438734e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.51623093e21,
                1.02267688e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                9.61904951e21,
                1.01911920e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPrior,
        [
            [
                8.15471288e22,
                8.07227297e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                8.14015725e22,
                9.44108991e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                6.80742559e21,
                4.53209759e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                7.45944807e22,
                4.90901602e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.45553710e20,
                7.12816357e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.column,
        [
            [
                1.49478678e23,
                7.20041083e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.49352172e23,
                1.00425207e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.27306302e22,
                3.90067659e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.36623639e23,
                6.14191044e17,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
            [
                1.26539064e20,
                6.19615649e18,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
                -9.99000000e02,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnAir,
        [2.09839208e25, 1.58891572e25, 5.53352862e24, 1.03557127e25, 5.09478146e24],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnTrue,
        [
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
            [
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
                -999.0,
            ],
        ],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMax,
        [986.3847, 986.3847, 500.0, 986.3847, 239.46081543],
        rtol=1e-6,
    )
    npt.assert_allclose(
        csum.columnPressureMin,
        [0.0, 239.46081543, 239.46081543, 500.0, 0.0],
        rtol=1e-6,
    )
    assert csum.columnSpecies == ["H2O", "O3"]
